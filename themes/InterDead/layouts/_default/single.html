{{ define "main" }}
<article class="gm-section gm-article">
  <div class="gm-container">
    <header class="gm-article__header">
      <div class="gm-article__heading">
        <h1 class="gm-section__title">{{ .Title }}</h1>
        <div class="gm-article__meta">
          {{ partial "components/category-list.html" (dict "categories" .Params.categories "class" "gm-article__categories" "label" (i18n "blog.categories")) }}
          {{ with .Date }}
          <p class="gm-text--fine gm-article__date">{{ .Format "02 Jan 2006" }}</p>
          {{ end }}
        </div>
      </div>
      {{ $imagePath := .Params.image }}
      {{ $cleanPath := cond (and $imagePath (hasPrefix $imagePath "/")) (strings.TrimPrefix "/" $imagePath) $imagePath }}
      {{ $convertedPath := cond $cleanPath (printf "converted-assets/%s" $cleanPath) "" }}
      {{ $imageResource := cond (and $cleanPath (not (hasPrefix $cleanPath "http"))) (or (resources.GetMatch $convertedPath) (resources.GetMatch $cleanPath) (.Resources.GetMatch $convertedPath) (.Resources.GetMatch $cleanPath)) nil }}
      {{ $resolvedImage := "" }}
      {{ if $imageResource }}
        {{ $resolvedImage = ($imageResource | fingerprint).RelPermalink }}
      {{ else if $imagePath }}
        {{ if hasPrefix $imagePath "http" }}
          {{ $resolvedImage = $imagePath }}
        {{ else }}
          {{ $resolvedImage = $imagePath | absURL }}
        {{ end }}
      {{ end }}
      {{ if and (ne .Section "blog") $resolvedImage }}
      <figure class="gm-article__media">
        <img src="{{ $resolvedImage }}" alt="{{ .Params.imageAlt | default .Title }}" loading="lazy" />
      </figure>
      {{ end }}
    </header>
    {{ $toc := .TableOfContents }}
    {{ $hasToc := and $toc (gt (len (findRE "<li" $toc)) 0) }}
    <div class="gm-article__layout{{ if $hasToc }} gm-article__layout--with-toc{{ end }}">
      {{ if $hasToc }}
        {{ partial "components/article-toc.html" (dict "toc" $toc) }}
      {{ end }}
      <div class="gm-card gm-article__body gm-content">{{ .Content }}</div>
    </div>
  </div>
</article>
{{ end }}
