{{- $title := .Title | default .Site.Title -}}
{{- $description := .Params.description | default .Site.Language.Params.description -}}
{{- $image := .Params.image | default .Site.Params.defaultImage -}}
{{- $canonical := .Permalink -}}
{{- $lang := .Language.Lang -}}
{{- $ogType := .Site.Params.ogType | default "website" -}}
{{- $twitterCard := .Site.Params.twitterCard | default "summary_large_image" -}}
{{- $logo := resources.Get "images/logo_png.png" | fingerprint -}}
{{- $appleTouchIcon := resources.Get "favicons/apple-touch-icon.png" | fingerprint -}}
{{- $favicon32 := resources.Get "favicons/favicon-32x32.png" | fingerprint -}}
{{- $favicon16 := resources.Get "favicons/favicon-16x16.png" | fingerprint -}}
{{- $siteManifest := resources.Get "favicons/site.webmanifest" | fingerprint -}}
{{- $imageIsRemote := and $image (hasPrefix $image "http") -}}
{{- $ogImage := "" -}}
{{- if $image -}}
  {{- if $imageIsRemote -}}
    {{- $ogImage = $image -}}
  {{- else -}}
    {{- $ogImage = $image | absURL -}}
  {{- end -}}
{{- else if $logo -}}
  {{- $ogImage = $logo.Permalink -}}
{{- end -}}
<!DOCTYPE html>
<html lang="{{ $lang }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ $title }}</title>
    {{- with $description }}
    <meta name="description" content="{{ . | plainify }}" />
    <meta property="og:description" content="{{ . | plainify }}" />
    <meta name="twitter:description" content="{{ . | plainify }}" />
    {{- end }}
    {{- with .Params.robots }}
    <meta name="robots" content="{{ . }}" />
    {{- end }}
    <link rel="canonical" href="{{ $canonical }}" />
    <meta property="og:type" content="{{ $ogType }}" />
    <meta property="og:title" content="{{ $title }}" />
    <meta property="og:url" content="{{ $canonical }}" />
    {{- with $ogImage }}
    <meta property="og:image" content="{{ . }}" />
    <meta name="twitter:image" content="{{ . }}" />
    {{- end }}
    <meta property="og:site_name" content="{{ .Site.Title }}" />
    <meta property="og:locale" content="{{ .Language.LanguageCode }}" />
    <meta name="twitter:card" content="{{ $twitterCard }}" />
    <meta name="twitter:title" content="{{ $title }}" />
    {{- with .Params.ogImageAlt | default (i18n "meta.ogImageAlt") }}
    <meta property="og:image:alt" content="{{ . | plainify }}" />
    {{- end }}
    <link rel="alternate" hreflang="{{ .Language.LanguageCode }}" href="{{ .Permalink }}" />
    {{- range .Translations }}
    <link rel="alternate" hreflang="{{ .Language.LanguageCode }}" href="{{ .Permalink }}" />
    {{- end }}
    <link rel="alternate" hreflang="x-default" href="{{ .Site.Home.Permalink }}" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ $appleTouchIcon.RelPermalink }}"
      integrity="{{ $appleTouchIcon.Data.Integrity }}"
      crossorigin="anonymous"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ $favicon32.RelPermalink }}"
      integrity="{{ $favicon32.Data.Integrity }}"
      crossorigin="anonymous"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ $favicon16.RelPermalink }}"
      integrity="{{ $favicon16.Data.Integrity }}"
      crossorigin="anonymous"
    />
    <link
      rel="manifest"
      href="{{ $siteManifest.RelPermalink }}"
      integrity="{{ $siteManifest.Data.Integrity }}"
      crossorigin="anonymous"
    />
    <meta name="theme-color" content="#0c0a12" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Noto+Serif+JP:wght@200..900&display=swap"
      rel="stylesheet"
    />
    {{- $styleAsset := resources.Get "css/styles.css" | resources.Minify | fingerprint }}
    {{- .Scratch.Set "interdeadStyles" $styleAsset }}
    <link
      rel="stylesheet"
      href="{{ $styleAsset.RelPermalink }}"
      integrity="{{ $styleAsset.Data.Integrity }}"
      crossorigin="anonymous"
    />
    {{- $jsOptions := dict "targetPath" "js/app.js" "format" "esm" "minify" (not hugo.IsServer) }}
    {{- if hugo.IsServer }}
      {{- $jsOptions = merge $jsOptions (dict "sourcemap" "inline") }}
    {{- end }}
    {{- $scriptAsset := resources.Get "js/app.js" | js.Build $jsOptions | fingerprint }}
    {{- .Scratch.Set "interdeadScript" $scriptAsset }}
    {{- with .Site.Config.Services.GoogleAnalytics.ID }}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', '{{ . }}');
    </script>
    {{- end }}
    {{- $featureFlags := .Site.Params.featureFlags | default dict -}}
    {{- $api := .Site.Params.api | default dict -}}
    {{- $auth := .Site.Params.auth | default dict -}}
    {{- $envBaseUrl := getenv (default "" $api.envVarBaseUrl) -}}
    <script>
      (() => {
        const config = {{ dict "featureFlags" $featureFlags "api" $api "auth" $auth | jsonify | safeJS }};
        const hostname = window.location.hostname;
        const apiBaseFromEnv = {{ $envBaseUrl | jsonify | safeJS }};
        const singleHostBaseUrl = (() => {
          const apiHostValues = Object.values(config.api.baseUrlByHost || {}).filter(
            url => typeof url === 'string' && url.trim().length > 0,
          );
          return apiHostValues.length === 1 ? apiHostValues[0] : '';
        })();
        const envBaseMap = {
          ...config.api.baseUrlByHost,
          'interdead.phantom-draft.com': config.api.baseUrlByHost?.['interdead.phantom-draft.com'] || config.api.prodBaseUrl,
        };
        const envMappedBaseUrl = envBaseMap[hostname];
        const baseUrlCandidates = [
          { source: 'envVar', value: apiBaseFromEnv },
          { source: 'config.baseUrl', value: config.api.baseUrl },
          { source: `hostMap:${hostname}`, value: envMappedBaseUrl },
          { source: 'config.defaultBaseUrl', value: config.api.defaultBaseUrl },
          { source: 'singleHostBaseUrl', value: singleHostBaseUrl },
          { source: 'config.prodBaseUrl', value: config.api.prodBaseUrl },
        ];
        const selectedBaseCandidate = baseUrlCandidates.find(
          ({ value }) => typeof value === 'string' && value.trim().length > 0,
        );
        const selectedBaseUrl = selectedBaseCandidate?.value || '';
        config.api.baseUrl = selectedBaseUrl;
        const baseUrlLogPayload = {
          hostname,
          selectedSource: selectedBaseCandidate?.source || 'none',
          baseUrl: selectedBaseUrl,
          candidates: baseUrlCandidates,
        };
        if (selectedBaseUrl) {
          console.info('[InterDead][Config] Selected API base URL', baseUrlLogPayload);
        } else {
          console.warn('[InterDead][Config] Failed to resolve API base URL; check configuration', baseUrlLogPayload);
        }
        window.__INTERDEAD_CONFIG__ = config;
      })();
    </script>
  </head>
  <body
    data-mode="{{ or (index .Site.Params "defaultMode") "demo" }}"
    data-profile-url="{{ "/profile/" | relLangURL }}"
    data-is-home="{{ if .IsHome }}true{{ else }}false{{ end }}"
  >
