# InterDeadIT Auth Session & Profile Presentation – Hexagonal Work Specification

| Section                                      | Field / Item                                           | Description / Notes                                                                                                   |
|----------------------------------------------|--------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------|
| **1. Requirement Overview**                  | Feature / Fix Title                                    | Persist authenticated session metadata and render authenticated user badge/profile page on InterDeadIT.                |
|                                              | Problem Statement & Value                              | Current site cannot distinguish authenticated visitors: the Discord CTA stays visible after login and no profile data is rendered. Backend session cookie lacks avatar/login fields and there is no session introspection endpoint, preventing UI from showing authenticated state or profile information. Providing a session read API and frontend badge/profile pages improves UX and enables gated views. |
|                                              | Constraints & Acceptance Metrics                       | 1) GET `/auth/session` returns `{ authenticated, profileId, displayName, avatarUrl, username }`, validates cookie signature, and refreshes TTL. 2) Session cookie stores avatar/login metadata at issuance. 3) Frontend replaces CTA with avatar+login badge when authenticated and falls back gracefully when unauthenticated or on fetch failure. 4) Mini-profile click opens Hugo profile page showing avatar + personal data table pulled from stored profile; page must be excluded from sitemap/robots, with custom sitemap.xml reflecting rule. 5) Localization-ready markup using `data-i18n` for texts; BEM classes for new UI. |
|                                              | Dependencies / External Inputs                         | Discord OAuth flow already issuing `interdead_session` via `CookieSessionStore`; Hugo content/templates under `InterDeadIT/content` and `themes/InterDead`; profile data stored via existing profile table/service in InterDeadCore accessible to worker. |
| **2. Layer & Component Impact Matrix**       | Instruction                                            | List every layer/component that participates in the change. For each line, describe the planned work or write “No updates”. |
| **Domain Layer (`src/core/`)**               | Business Rules                                         | No new business rules; reuse existing profile semantics. |
|                                              | Entities / Value Objects / Aggregates                  | No updates. |
|                                              | Domain Events                                          | No updates. |
| **Application Layer (`src/application/`)**   | Use Case Services / Orchestrators                      | Add `AuthStateService` (frontend) to fetch `/auth/session`, cache state, emit events (e.g., `AUTH_SESSION_UPDATED`). |
|                                              | Event Bus Contracts / Notifications                    | Introduce event names for session updates; ensure unsubscribe on dispose. |
|                                              | Validation / Policies                                  | Validate session response shape; handle unauthenticated as explicit state. |
| **Ports (`src/ports/`)**                     | Inbound Ports (driving adapters → application)         | If existing EventBus/HTTP ports are reused, no new interfaces; otherwise define an HTTP fetch port for auth session retrieval. |
|                                              | Outbound Ports (application → driven adapters)         | No new outbound ports beyond HTTP fetch adapter. |
| **Adapters (`src/adapters/`)**               | UI Adapters / Presenters                               | Extend/implement adapter to render user badge (avatar/login) and toggle CTA visibility via BEM modifiers. |
|                                              | Infrastructure Adapters (camera, storage, network, etc.) | Add HTTP adapter call to `/auth/session` (fetch with credentials). Extend auth worker (Cloudflare worker) to serve session endpoint and persist metadata in session cookie. |
|                                              | Logging / Error Handling Hooks                         | Log session fetch failures via existing logging adapter; surface fallback UI state. |
| **Presentation Layer**                       | View Models / Widgets                                  | Add `UserBadgeController` (or enhance `AuthButtonController`) to swap CTA with badge; add profile page template/shortcode for Hugo rendering avatar + data table. |
| (`src/presentation/`, `assets/css/main.css`) | BEM Blocks / Elements / Modifiers                      | New block `auth-badge` with elements `__avatar`, `__name`, modifier `--hidden`; CTA block gains modifier to hide when authenticated. |
|                                              | Translation Hooks (`data-i18n`)                        | Add keys for badge labels and profile page headings using `data-i18n`. |
| **Configuration & Infrastructure**           | Feature Flags / Runtime Configs                        | Consider flag for session badge rollout if config file exists; otherwise document “No new flags”. |
| (`src/config/`, `src/infrastructure/`)       | Bootstrapping / Container Registration                 | Register `AuthStateService` and controllers in app bootstrap (InterDeadIT `app.js`); ensure worker routing includes `/auth/session`. |
| **Shared Utilities (`src/utils/`)**          | Helpers / Guards                                       | Optional helper to normalize profile payload; otherwise no change. |
| **Localization (`src/i18n/`)**               | New Keys / Updates                                     | Add keys for “Profile”, “Logged in as”, error/fallback messages if displayed. |
| **Tests**                                    | Unit / Integration / UI Tests                          | Worker tests: session endpoint validates cookie, includes avatar/login, refreshes TTL. Frontend tests: service emits authenticated/unauthenticated states; controller toggles CTA/badge. Hugo page rendering test (snapshot) if test harness exists; otherwise manual checklist. |
| **Documentation & Operational Notes**        | README / Wiki Updates                                  | Document `/auth/session` contract and profile page behavior in InterDeadIT README/wiki. |
|                                              | Migration Steps / Data Considerations                  | Existing sessions lack avatar/login; instruct users to re-authenticate or handle null fields gracefully. |
| **3. Execution Stages**                      | Instruction                                            | Plan the order of work so contracts stabilize before adapters, and infrastructure/UI changes respect OOP and BEM boundaries. |
| **Execution Stage 1**                        | Domain validation                                      | Confirm no new business rules; reuse profile entity structure. |
| **Execution Stage 2**                        | Application contracts                                  | Define `AuthStateService` API (methods, events) and session payload shape; specify badge/controller responsibilities. |
| **Execution Stage 3**                        | Ports alignment                                        | Add/update port for auth session fetch if needed; ensure EventBus event names are reserved. |
| **Execution Stage 4**                        | Adapter implementations                                | Implement worker `/auth/session`; extend `CookieSessionStore.issueSession` to include `avatarUrl`/`username` and refresh TTL on read. Add HTTP adapter call with credentials. |
| **Execution Stage 5**                        | Presentation & Styling                                 | Add badge UI (BEM), integrate `data-i18n` texts, update CTA logic, and add Hugo profile page + shortcode rendering avatar and profile data table; ensure mini-profile links to `/profile` (or chosen slug) and page blocks indexing (robots meta or sitemap exclusion). |
| **Execution Stage 6**                        | Configuration & Infrastructure wiring                  | Wire services/controllers in `themes/InterDead/static/js/app.js`; ensure sitemap.xml generation excludes profile page; set Hugo per-locale page with noindex. |
| **Execution Stage 7**                        | Testing & documentation                                | Add worker/unit tests and UI tests; update README/wiki and provide manual test checklist (auth flow, repeat auth updates badge, profile page data). |

## Additional Implementation Notes
- Hugo Profile Page: create a `content/profile/_index.*` (per locale) rendering via shortcode to display avatar + data table; add `robots` noindex header and exclude from sitemap by custom `layouts/sitemap.xml`. Mini-profile badge links here.
- Shortcodes: implement reusable shortcode under `themes/InterDead/layouts/shortcodes/profile-badge.html` (or similar) to render avatar/login block and profile data table using session/profile data from injected script or API call.
- Authorization Awareness: controllers must listen to `AuthStateService` events to swap CTA/badge and re-render on repeated logins; unauthenticated state hides profile link.
- Accessibility & Fallbacks: provide alt text for avatar, handle missing avatar URL with placeholder, and ensure keyboard activation for badge link.
- Localization: all user-facing strings (Profile, Logged in as, View profile, No data) must have `data-i18n` attributes and keys in `InterDeadIT/i18n` bundles.
- Sitemap & Indexing: implement custom `sitemap.xml` template excluding `/profile`; add `<meta name="robots" content="noindex,nofollow">` to profile page layout.

