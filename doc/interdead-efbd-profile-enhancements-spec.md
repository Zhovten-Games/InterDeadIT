## Hexagonal Work Specification Template

| Section                                      | Field / Item                                           | Description / Notes |
|----------------------------------------------|--------------------------------------------------------|---------------------|
| **1. Requirement Overview**                  | Feature / Fix Title                                    | EFBD profile surfacing, homepage auth UX alignment, translations, and breadcrumbs update. |
|                                              | Problem Statement & Value                              | EFBD scale writes currently use loosely coupled `profileId` values and no read path; the `/profile` view only shows session metadata. Homepage login/countdown components misalign with auth state, and header visibility rules differ per page. Narrative translation needs consistent "Истории" lead-in across locales; pricing copy for "Nostalgia" plan must be removed; breadcrumbs are missing site-wide except the homepage. Addressing these improves data consistency, UX clarity, and localization narrative. |
|                                              | Constraints & Acceptance Metrics                       | New EFBD summary endpoint must return authenticated user’s scale data from `efbd_scale` using session profile ID by default. Profile page renders avatar centered with EFBD data in dossier layout (avatar right on wide screens, top on small). Homepage countdown hidden after auth; login and countdown blocks share equal height; header login button appears only when not already visible on the homepage but remains always visible on other pages along with logo. Localization block after "Stories that should never have happened" must start with "Истории" across locales. Remove Marina “Nostalgia” plan references from UI and locale files. Add breadcrumbs to all non-home pages. Styles adhere to BEM naming. |
|                                              | Dependencies / External Inputs                         | Existing Cloudflare worker auth session, `efbd_scale` table schema, localization files under `InterDeadIT/i18n`, homepage/header templates, profile page layout, CSS in `assets/css/main.css` or theme styles. |
| **2. Layer & Component Impact Matrix**       | Instruction                                            | List every layer/component that participates in the change. For each line, describe the planned work or write “No updates”. |
| **Domain Layer (`src/core/`)**               | Business Rules                                         | No new business rules; reuse existing scale interpretation. |
|                                              | Entities / Value Objects / Aggregates                  | No updates. |
|                                              | Domain Events                                          | No updates. |
| **Application Layer (`src/application/`)**   | Use Case Services / Orchestrators                      | Add EFBD summary retrieval use case for authenticated profile; adjust trigger ingestion to default to session profile ID when present. |
|                                              | Event Bus Contracts / Notifications                    | No updates. |
|                                              | Validation / Policies                                  | Enforce authentication requirement for EFBD summary and ID binding. |
| **Ports (`src/ports/`)**                     | Inbound Ports (driving adapters → application)         | Define inbound port for `GET /efbd/summary` and ensure auth guard; refine trigger ingestion port to accept optional session profile ID. |
|                                              | Outbound Ports (application → driven adapters)         | Extend repository port to fetch EFBD scale entries by profile ID; confirm write path aligns with session-bound IDs. |
| **Adapters (`src/adapters/`)**               | UI Adapters / Presenters                               | New frontend adapter/service to call EFBD summary endpoint on `/profile`; presenter to map response to dossier view model. Update header/homepage adapters controlling login/countdown visibility. |
|                                              | Infrastructure Adapters (camera, storage, network, etc.) | Cloudflare worker route for EFBD summary using repository adapter; modify ingestion adapter to derive profile ID from session when available. |
|                                              | Logging / Error Handling Hooks                         | Add logs for EFBD summary access and auth failures as needed. |
| **Presentation Layer**                       | View Models / Widgets                                  | Profile page view updated to include EFBD scale data and avatar positioning; homepage header/login/countdown visibility logic; breadcrumbs widget added to non-home layouts. |
| (`src/presentation/`, `assets/css/main.css`) | BEM Blocks / Elements / Modifiers                      | Add/adjust BEM classes for dossier layout, equal-height auth blocks, header visibility modifiers, breadcrumb block, and localization text alignment. |
|                                              | Translation Hooks (`data-i18n`)                        | Ensure new or updated strings (EFBD labels, breadcrumbs, narrative headings) use `data-i18n` bindings. |
| **Configuration & Infrastructure**           | Feature Flags / Runtime Configs                        | Add config for EFBD summary endpoint path and DI registration; adjust boot order if new services added. |
| (`src/config/`, `src/infrastructure/`)       | Bootstrapping / Container Registration                 | Register EFBD summary service/adapter and ensure header/home controllers receive dependencies for auth state checks. |
| **Shared Utilities (`src/utils/`)**          | Helpers / Guards                                       | Add helper for viewport detection if needed for responsive avatar placement; reuse existing utilities where possible. |
| **Localization (`src/i18n/`)**               | New Keys / Updates                                     | Add/update keys for EFBD scale fields, breadcrumbs labels, and ensure the block following "Stories that should never have happened" starts with "Истории" across locales; remove Marina “Nostalgia” plan strings. |
| **Tests**                                    | Unit / Integration / UI Tests                          | Add worker tests for EFBD summary endpoint auth and data retrieval; update frontend/profile tests for dossier rendering; adjust homepage/header visibility tests; update localization snapshot/tests if present. |
| **Documentation & Operational Notes**        | README / Wiki Updates                                  | Note new endpoint and UI behavior in relevant docs. |
|                                              | Migration Steps / Data Considerations                  | Confirm existing EFBD entries lacking session-linked profile IDs may not surface; consider backfill guidance if needed. |
| **3. Execution Stages**                      | Instruction                                            | Plan the order of work so contracts stabilize before adapters, and infrastructure/UI changes respect OOP and BEM boundaries. |
| **Execution Stage 1**                        | Domain validation                                      | Confirm no new business rules; document reliance on existing scale schema and profile binding requirement. |
| **Execution Stage 2**                        | Application contracts                                  | Define EFBD summary use case and ports for reading by session profile; adjust ingestion contract to prefer session profile ID; specify auth policy. |
| **Execution Stage 3**                        | Ports alignment                                        | Update inbound/outbound port interfaces and data DTOs for EFBD summary retrieval and session-bound writes. |
| **Execution Stage 4**                        | Adapter implementations                                | Implement Cloudflare worker route and repository queries; update ingestion adapter for session ID default. Build frontend adapter/service to fetch summary, integrate into profile controller, and adjust header/home controllers for visibility rules. |
| **Execution Stage 5**                        | Presentation & Styling                                 | Implement dossier layout on `/profile` (avatar center/right vs responsive stack), equal-height login/countdown blocks, header visibility/anim behavior scoped to homepage, persistent header/logo visibility on other pages, breadcrumb UI for non-home pages, and localized narrative heading adjustments; enforce BEM naming. |
| **Execution Stage 6**                        | Configuration & Infrastructure wiring                  | Register new services/adapters in DI/container/config; expose endpoint paths; ensure auth middleware applied. |
| **Execution Stage 7**                        | Testing & documentation                                | Add/adjust automated tests for worker endpoint, profile rendering, homepage/header behavior, breadcrumb presence, and localization changes; update docs for new endpoint and UX rules. |
